//------------------------------------------------------------------------------
// Author: Lukasz Janyst <lukasz@jany.st>
// Date:   06.08.2017
//------------------------------------------------------------------------------

#pragma once

#include "utils.hh"

#include <Eigen/Core>
#include <string>
#include <vector>

//------------------------------------------------------------------------------
//! Map
//------------------------------------------------------------------------------
class Map {
  public:
    //--------------------------------------------------------------------------
    //! Constructor
    //--------------------------------------------------------------------------
    Map() {};

    //--------------------------------------------------------------------------
    //! Destructor
    //--------------------------------------------------------------------------
    virtual ~Map() {};

    //--------------------------------------------------------------------------
    //! Load map data from file
    //--------------------------------------------------------------------------
    void LoadFromFile(const std::string &filename, bool interpolate = true);

    //--------------------------------------------------------------------------
    //! Compute a polynomial fitted to the waypoints in the car's frame of
    //! referrence
    //--------------------------------------------------------------------------
    Eigen::VectorXd ComputeWaypointPoly(int lane, const Vehicle &v) const;

    //--------------------------------------------------------------------------
    //! Get numer of lanes
    //--------------------------------------------------------------------------
    int NumLanes() const { return 3; }

    //--------------------------------------------------------------------------
    //! Find the lane the car is in
    //--------------------------------------------------------------------------
    int Lane(const Vehicle &c) const;

  private:
    //--------------------------------------------------------------------------
    //! Waypoint
    //--------------------------------------------------------------------------
    struct WayPoint {
      WayPoint(const Eigen::VectorXd &xyp, double sp,
               const Eigen::VectorXd &dp):
        xy(xyp), s(sp), d(dp) {}

      Eigen::VectorXd xy;
      double          s;
      Eigen::VectorXd d;
    };

    //--------------------------------------------------------------------------
    // Add lane waypoints
    //--------------------------------------------------------------------------
    void AddLaneWaypoints(int lane, const std::vector<WayPoint> &waypoints);

    //--------------------------------------------------------------------------
    // Interpolate lane waypoints
    //--------------------------------------------------------------------------
    void InterpolateLaneWaypoints(int lane,
                                  const std::vector<WayPoint> &waypoints);

    //--------------------------------------------------------------------------
    // Data members
    //--------------------------------------------------------------------------
    std::vector<std::vector<Eigen::VectorXd>> waypoints_;
    const int                                 lane_width_ = 4;
};
